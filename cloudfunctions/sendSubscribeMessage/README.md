# 订阅消息发送云函数

此云函数用于发送微信小程序订阅消息，实现在后台任务完成时主动通知用户。

## 部署步骤

1. 确保你已经开通了云开发服务
2. 在微信开发者工具中，右键点击cloudfunctions目录下的sendSubscribeMessage文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

## 小程序配置

### 订阅消息模板配置

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入"功能"->"订阅消息"
3. 确认模板ID bFGSlc6zR4QOHx5QVeP5OtCiwIlTIHcY8S0qXw_o8Zw 已添加并启用
4. 如需创建新模板，请添加以下字段：
   - 服务名称 {{thing7.DATA}}
   - 服务时间 {{time10.DATA}}
   - 任务状态 {{phrase5.DATA}}

### 调用权限配置

1. 在微信公众平台，进入"开发"->"开发管理"->"接口设置"
2. 确保"订阅消息"API已开通
3. 如需修改调用频率或额度，请在该页面进行设置

## 常见问题

### 如何测试订阅消息功能？

1. 在小程序中使用找项目或找载体等功能
2. 在处理过程中，切换到其他页面或退出小程序
3. 请求处理完成后，应收到订阅消息通知

### 订阅消息频率限制

- 同一用户在同一个小程序下的统一模板ID，最多只能发送3条（正式环境）
- 计数周期为单日内（0点-24点）
- 超过限制后，将无法再向用户发送订阅消息

### 未收到订阅消息的常见原因

1. 用户未授权订阅消息权限
2. 用户达到了订阅消息数量限制
3. 云函数部署失败或执行出错
4. 小程序未正确配置订阅消息模板

## 调试方法

如果订阅消息发送失败，请检查以下日志：

1. 微信开发者工具的"云开发"->"云函数"->"日志查询"
2. 小程序端的console日志中的订阅消息请求结果
3. 模板ID是否配置正确

## 更多资源

- [微信官方文档：订阅消息](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)
- [云开发文档：订阅消息](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/open/message.html) 